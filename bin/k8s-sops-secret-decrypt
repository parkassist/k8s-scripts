#!/usr/bin/env bash
set -o errexit

. k8s-read-config

if [ -z "$SOPS_KMS_ARN" ];              then echo SOPS_KMS_ARN must be set; exit 1; fi

if ! hash sops > /dev/null 2>&1; then
  echo "sops binary not found! Exiting."
  exit 1
fi


for index in "${!SOPS_SECRETS[@]}"
do
  sops_secret="${SOPS_SECRETS[$index]}"
  sops --kms ${SOPS_KMS_ARN} --decrypt deploy/${sops_secret}.secret.sops.yml \
  > deploy/${sops_secret}.secret.yml
done

